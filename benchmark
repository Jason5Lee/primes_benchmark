#!/bin/bash
set -e

BIT_FLAG=--uint64
for arg in "$@"
do
    case $arg in
        --typescript)
            TYPESCRIPT=true
            ;;
        --rust)
            RUST=true
            ;;
        --scala)
            SCALA=true
            ;;
        --java)
            JAVA=true
            ;;
        --all)
            TYPESCRIPT=true
            RUST=true
            SCALA=true
            JAVA=true
            ;;
        --uint64)
            BIT_FLAG=--uint64
            ;;
        --uint32)
            BIT_FLAG=--uint32
            ;;
        *)
            echo "Unknown argument: $arg"
            exit 1
            ;;
    esac
done

if [ $TYPESCRIPT ] ; then
    echo "Compiling TypeScript..."
    cd typescript
    npm install
    tsc
    cd ..
fi

if [ $RUST ] ; then
    echo "Compiling Rust..."
    cd rust
    cargo build --release
    cd ..
fi

if [ $SCALA ] ; then
    echo "Compiling Scala..."
    cd scala
    sbt compile
    cd ..
fi

if [ $JAVA ] ; then
    echo "Compiling Java"
    cd java
    rm -rf out && mkdir out
    javac src/Main.java -d out
    cd ..
fi

echo "Compilation completed."
echo
echo "Language   | Slowest time | Average time"
echo "----------------------------------------"
if [ $TYPESCRIPT ] ; then
    echo -n -e "TypeScript |"
    node typescript/app.js
fi
if [ $RUST ] ; then
    echo -n -e "Rust       |"
    rust/target/release/primes_benchmark $BIT_FLAG
fi
if [ $SCALA ] ; then
    echo -n -e "Scala      |"
    cd scala/target/scala-2.12/classes
    java -classpath $HOME/.ivy2/cache/org.scala-lang/scala-library/jars/scala-library-2.12.8.jar:. Main $BIT_FLAG
    cd ../../../..
fi
if [ $JAVA ] ; then
    echo -n -e "Java       |"
    cd java/out
    java Main $BIT_FLAG
    cd ../..
fi
echo "----------------------------------------"